
-- Enable CLR
sp_configure 'clr enabled', 1;
RECONFIGURE WITH OVERRIDE;
GO

--Drop the functions if they already exist
DROP FUNCTION IF EXISTS CURL.XGET
GO
DROP PROCEDURE IF EXISTS CURL.XPOST
GO

--Drop the schema if it already exists
DROP SCHEMA IF EXISTS CURL;
GO

--Drop "trusted assembly flag" if it is set

DECLARE @hash VARBINARY(64);

SELECT @hash = hash
FROM sys.trusted_assemblies ta
WHERE ta.description = N'SqlClrCurl'

if (@hash is not null)
	EXEC sp_drop_trusted_assembly @hash;
GO

--Drop the assembly if it already exists
DROP ASSEMBLY IF EXISTS SqlClrCurl;
GO

DECLARE @assembly VARBINARY(MAX) = 0x4D5A90000300000004000000FFFF0000B800000000000000400000000000000000000000000000000000000000000000000000000000000000000000800000000E1FBA0E00B409CD21B8014CCD21546869732070726F6772616D2063616E6E6F742062652072756E20696E20444F53206D6F64652E0D0D0A2400000000000000504500004C010300BB36C1650000000000000000E00022200B013000001000000008000000000000962F00000020000000400000000000100020000000020000040000000000000006000000000000000080000000020000A4E00000030060850000100000100000000010000010000000000000100000000000000000000000442F00004F000000004000002C04000000000000000000000000000000000000006000000C00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000200000080000000000000000000000082000004800000000000000000000002E746578740000009C0F0000002000000010000000020000000000000000000000000000200000602E727372630000002C040000004000000006000000120000000000000000000000000000400000402E72656C6F6300000C0000000060000000020000001800000000000000000000000000004000004200000000000000000000000000000000782F00000000000048000000020005007C220000480C000009000000000000000000000000000000C42E0000800000000000000000000000000000000000000000000000000000000000000000000000621980010000041F32800200000420000C0000281200000A2A000000133002003100000001000011731300000A0A0206280500000606036F1400000A0B1201281500000A281600000A6F1700000A6F1800000A731900000A2A000000133003006300000002000011731300000A0A02062805000006036F1A00000A2C1072010000707271000070731B00000A7A06046F1400000A0C1202281500000A281600000A036F1400000A0C1202281500000A6F1C00000A0B281D00000A727700007007281E00000A6F1F00000A2A001B300500D900000003000011731300000A0A02062805000006036F1A00000A2C1072010000707271000070731B00000A7A7E010000040B72A30000700C0006046F1400000A0D1203281500000A281600000A036F1400000A0D1203281500000A6F1C00000A0C150BDE611304281D00000A1B8D1B000001251672A5000070A2251711046F2000000AA2251872B5000070A225197E0200000413051205282100000AA2251A72CB000070A2282200000A6F1F00000A0717590B7E02000004282300000ADE0007163D72FFFFFF07153315281D00000A72D300007008281E00000A6F1F00000A2A00000001100000000032002C5E005A17000001133005005200000004000011026F1A00000A2D49026F1400000A0B1201281500000A0A06282400000A2D3206178D2100000125161F3B9D6F2500000A0C160D2B1608099A1304036F2600000A11046F2700000A0917580D09088E6932E42A1E02282800000A2A000042534A4201000100000000000C00000076342E302E33303331390000000005006C00000090030000237E0000FC0300006804000023537472696E6773000000006408000000010000235553006409000010000000234755494400000074090000D402000023426C6F620000000000000002000001571502000900000000FA01330016000001000000220000000200000002000000060000000B00000028000000120000000400000001000000030000000000B30201000000000006009C01AF0306001B02AF030600A5007D030F00CF0300000600CD00F40206007F01F40206004B01F40206000202F4020600BC01F4020600E701F4020600FA00F4020600B900900306009700900306002E01F40206001501540206000F04ED020A006A0155030A00D50155030A00F303DE030E002B041A040A009C02DE030A00E400550306002203ED020E0041031A040E0082001A040E00AF02ED020600A802ED0206001A03ED020A00410455030A007A00550306000100ED0206004200430206003203ED020E0006031A04000000000700000000000100010001000000E802000041000100010031002100460131001200460150200000000091187603490101006C2000000000960016044D010100AC200000000096003C04560104001C210000000096005804560107001422000000009100370360010A007222000000008618700306000C0000000000000000000100100000000200E90200000100100000000200500000000300E90200000100100000000200500000000300E902000001001000000002003504090070030100110070030600190070030A00290070031000310070031000390070031000410070031000490070031000510070031000590070031000610070031500690070031000710070031000790070031000890070030600910070030600B10070030600C100CD021A00A1007003060099009A022700A90039022C00D1008A023000A1006E023500D9004C043A00990070033F009900C2024D00E10070035100A1007D025700E90071005D00D90008046200F1004D001000B90065002C00F900A6022C00D9000804740001012C037A00D90052008900D90025048E00A100FC03950011014900100081007003060024008300C1022E000B0068012E00130071012E001B0090012E00230099012E002B00A9012E003300EB012E003B00F1012E00430000022E004B001F022E005300EB012E005B00EB012E00630037022E006B0061022E0073006E0240007B00BC0260008B00BC0280008B00BC022000450068007F0004800000010000000000000001000000A400E20200000400000000000000000000009B003900000000000400000000000000000000009B002D00000000000400000000000000000000009B00ED0200000000000000496E743332003C4D6F64756C653E00480044454C41595F4F4E5F4552524F520052455452595F434F554E540053797374656D2E44617461006D73636F726C696200546872656164004164640053656E640049734E756C6C4F7257686974655370616365006765745F4D657373616765006765745F506970650053716C5069706500536563757269747950726F746F636F6C5479706500477569644174747269627574650044656275676761626C6541747472696275746500436F6D56697369626C6541747472696275746500417373656D626C795469746C654174747269627574650053716C50726F63656475726541747472696275746500417373656D626C7954726164656D61726B417474726962757465005461726765744672616D65776F726B41747472696275746500417373656D626C7946696C6556657273696F6E41747472696275746500417373656D626C79436F6E66696775726174696F6E4174747269627574650053716C46756E6374696F6E41747472696275746500417373656D626C794465736372697074696F6E41747472696275746500436F6D70696C6174696F6E52656C61786174696F6E7341747472696275746500417373656D626C7950726F647563744174747269627574650053716C466163657441747472696275746500417373656D626C79436F7079726967687441747472696275746500417373656D626C79436F6D70616E794174747269627574650052756E74696D65436F6D7061746962696C697479417474726962757465006765745F56616C75650053797374656D2E546872656164696E670053797374656D2E52756E74696D652E56657273696F6E696E6700446F776E6C6F6164537472696E670055706C6F6164537472696E6700457363617065557269537472696E6700546F53716C537472696E6700546F537472696E67005572690053716C436C724375726C2E646C6C006765745F49734E756C6C007365745F536563757269747950726F746F636F6C0053716C436C724375726C0053797374656D0053797374656D2E5265666C656374696F6E00576562486561646572436F6C6C656374696F6E00417267756D656E74457863657074696F6E00536C6565700043686172004164644865616465720053657276696365506F696E744D616E61676572004D6963726F736F66742E53716C5365727665722E536572766572002E63746F72002E6363746F720053797374656D2E446961676E6F73746963730053797374656D2E52756E74696D652E496E7465726F7053657276696365730053797374656D2E52756E74696D652E436F6D70696C6572536572766963657300446562756767696E674D6F6465730053797374656D2E446174612E53716C54797065730053716C4368617273006765745F4865616465727300436F6E636174004F626A656374004765740053797374656D2E4E65740053706C697400576562436C69656E7400636C69656E7400506F73740053716C436F6E7465787400546F43686172417272617900506F7374576974685265747279000000006F59006F00750020006D007500730074002000730070006500630069006600790020006400610074006100200074006800610074002000770069006C006C002000620065002000730065006E007400200074006F002000740068006500200065006E00640070006F0069006E007400000540006400002B52006500710075006500730074002000690073002000650078006500630075007400650064002E0020000001000F4500720072006F0072003A00090000152E002000570061006900740069006E006700200000076D0073002E00002952006500710075006500730074002000690073002000650078006500630075007400650064002E00000000008583BC733B739347942993084BA9021B00042001010803200001052001011111042001010E04200101020500010111650607021251115504200011550320000E0400010E0E0420010E0E0420001D03052001011D0307070312510E115503200002052002010E0E0520020E0E0E04000012790500020E0E0E0B07061251080E1155125D080500010E1D0E04000101080907050E11551D0E080E040001020E0620011D0E1D0305200012808908B77A5C561934E08980A00024000004800000940000000602000000240000525341310004000001000100A53A0C763126FE5E2653FF2DB0F2A2E42C01C63EEAE0DFA3FA3768D2BB708D986C696F5B220F2484C150B1F763B099EFDACC0A4976A14F7BD108F239DC90AC7CB5F3E3D5D2EED90DBE1A447911A3C0241879B6D6F3D59413D2D3BE6AC1BE720D6344F93FA989E42DA3F6373585A362F0CFF3F1EA910E5693D4DE9240B81E5FB202060803000001080002124D124D124D09000301124D124D124D07000201124D12510801000800000000001E01000100540216577261704E6F6E457863657074696F6E5468726F7773010801000200000000000F01000A53716C436C724375726C00004101003C496D706C656D656E746174696F6E206F66204355524C20636F6D6D616E6420696E2053514C2053657276657220446174616261736520456E67696E6500000501000000000E0100094D6963726F736F667400001E01001953716C20536572766572204769744875622053616D706C6573000017010012436F7079726967687420C2A920203230313800002901002432363565306263332D616435662D343466332D626231372D63363166373762393834376600000C010007312E302E302E3000004D01001C2E4E45544672616D65776F726B2C56657273696F6E3D76342E372E320100540E144672616D65776F726B446973706C61794E616D65142E4E4554204672616D65776F726B20342E372E32040100000012010001005408074D617853697A65FFFFFFFF4F7B972985FEEEBDBECF0F5DE6BE3B86EC71D4F1D7A90CBA66981F077888D741A39E18C1B08039DF12865A7B0B9AB41975AA13E029FD2F8EA51A0FF060B55480E431CB00D6195D3E96483D17432D3203D2B3CC0F3B5E477E45F36E8A8948271455798F51D5BE1C88BB577DEC66788FD488770F601C1FFC9330C0717671D1A0A56C2F00000000000000000000862F0000002000000000000000000000000000000000000000000000782F0000000000000000000000005F436F72446C6C4D61696E006D73636F7265652E646C6C0000000000FF25002000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000100100000001800008000000000000000000000000000000100010000003000008000000000000000000000000000000100000000004800000058400000D00300000000000000000000D00334000000560053005F00560045005200530049004F004E005F0049004E0046004F0000000000BD04EFFE00000100000001000000000000000100000000003F000000000000000400000002000000000000000000000000000000440000000100560061007200460069006C00650049006E0066006F00000000002400040000005400720061006E0073006C006100740069006F006E00000000000000B00430030000010053007400720069006E006700460069006C00650049006E0066006F0000000C030000010030003000300030003000340062003000000092003D00010043006F006D006D0065006E0074007300000049006D0070006C0065006D0065006E0074006100740069006F006E0020006F00660020004300550052004C00200063006F006D006D0061006E006400200069006E002000530051004C002000530065007200760065007200200044006100740061006200610073006500200045006E00670069006E0065000000000034000A00010043006F006D00700061006E0079004E0061006D006500000000004D006900630072006F0073006F006600740000003E000B000100460069006C0065004400650073006300720069007000740069006F006E0000000000530071006C0043006C0072004300750072006C0000000000300008000100460069006C006500560065007200730069006F006E000000000031002E0030002E0030002E00300000003E000F00010049006E007400650072006E0061006C004E0061006D0065000000530071006C0043006C0072004300750072006C002E0064006C006C00000000004800120001004C006500670061006C0043006F007000790072006900670068007400000043006F0070007900720069006700680074002000A90020002000320030003100380000002A00010001004C006500670061006C00540072006100640065006D00610072006B007300000000000000000046000F0001004F0072006900670069006E0061006C00460069006C0065006E0061006D0065000000530071006C0043006C0072004300750072006C002E0064006C006C000000000054001A000100500072006F0064007500630074004E0061006D00650000000000530071006C00200053006500720076006500720020004700690074004800750062002000530061006D0070006C00650073000000340008000100500072006F006400750063007400560065007200730069006F006E00000031002E0030002E0030002E003000000038000800010041007300730065006D0062006C0079002000560065007200730069006F006E00000031002E0030002E0030002E003000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002000000C000000983F00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
DECLARE @hash VARBINARY(64);
SELECT @hash = HASHBYTES('SHA2_512', @assembly)

IF(not exists (select * from sys.trusted_assemblies where hash = @hash))
	EXEC sp_add_trusted_assembly @hash, N'SqlClrCurl'
ELSE
	print 'Hash already exists'

--Create the assembly
CREATE ASSEMBLY SqlClrCurl
FROM @assembly
WITH PERMISSION_SET = EXTERNAL_ACCESS;
GO

--Create the schema where CURL modules will be placed.
CREATE SCHEMA CURL;
GO

--Create the function/procedure
CREATE FUNCTION CURL.XGET (@H NVARCHAR(MAX), @url NVARCHAR(4000))
RETURNS NVARCHAR(MAX)
AS EXTERNAL NAME SqlClrCurl.Curl.Get;
GO

CREATE PROCEDURE CURL.XPOST (@H NVARCHAR(MAX), @d NVARCHAR(MAX), @url NVARCHAR(4000))
AS EXTERNAL NAME SqlClrCurl.Curl.Post;
GO
